<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RideWise ‚Äì Vanilla HTML Demo (Mobile Refactor)</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --brand:#ef4444; --brand-ink:#7f1d1d;
      --radius:16px;
      /* NEW COLOR PALETTE FOR MOBILE */
      --primary-mobile: #5c30ea; /* Purple for key actions */
      --secondary-mobile: #3c239d; /* Darker purple */
      --action-button: #5c30ea; 
      --impact-card-bg: #eef2f6; 
      --impact-value-color: #0f172a; 
      --impact-label-color: #475569; 
    }
    *{box-sizing:border-box}
    /* Set a more mobile-friendly base font size */
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:var(--ink);background:linear-gradient(#fff,var(--bg)) min(100vh,100svh); font-size: 15px;} 
    button,input,select,textarea{font:inherit}
    a{color:inherit}

    /* Layout */
    .container{max-width:1100px;margin-inline:auto;padding:16px}
    .row{display:grid;gap:16px}
    @media(min-width:900px){.row-5{grid-template-columns:3fr 2fr}}

    /* UI atoms */
    .nav{position:sticky;top:0;z-index:100;backdrop-filter:saturate(180%) blur(8px);background:color-mix(in oklab, #fff 80%, transparent)}
    .nav-inner{display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--line);padding:12px 16px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:#0f172a}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--line);background:#fff;border-radius:12px;cursor:pointer}
    .btn:hover{background:#f1f5f9}
    .btn.primary{background:var(--ink);color:#fff;border-color:var(--ink)}
    .btn.brand{background:var(--brand);border-color:var(--brand);color:white}
    .btn.ghost{border-color:transparent;background:transparent}
    .btn.block{width:100%;justify-content:center}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius)}
    .card-h{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px}
    .card-c{padding:14px 16px}
    .pill{border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px}
    .switch{appearance:none;width:44px;height:26px;border-radius:999px;background:#cbd5e1;position:relative;outline:none;cursor:pointer;border:1px solid #94a3b8}
    .switch:checked{background:#22c55e;border-color:#16a34a}
    .switch:before{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:transform .15s ease}
    .switch:checked:before{transform:translateX(18px)}
    .grid-2{display:grid;gap:12px}
    @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
    .grid-3{display:grid;gap:12px}
    @media(min-width:720px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
    .muted{color:var(--muted)}
    .title{font-weight:700}
    /* FIX: Ensure H1 scales down correctly */
    .h1{font-size:clamp(24px,7vw,44px);line-height:1.1;margin:12px 0}
    .hidden{display:none !important}

    /* Map mock */
    .map{position:relative;min-height:380px;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;background-color:#e0e0e0;}
    .map-chip{position:absolute;top:12px;left:12px;z-index:2}
    
    /* List rows */
    .row-item{border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;gap:10px;align-items:center}
    .avatar{inline-size:36px;block-size:36px;border-radius:50%;background:#f1f5f9;display:grid;place-items:center;font-weight:700}

    /* Footer action grid */
    .grid-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    /* Sections */
    .section{padding-block:16px}

    /* Tabs (screens) */
    .screen{display:none;animation:fade .18s ease}
    .screen.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}

    /* Badges */
    .k{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px dashed var(--line);border-radius:12px;font-size:12px}
    .k.full-width {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* ADDED: Consistent metric styling for Rewards screen */
    .metric-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--ink);
    }

    /* Chat Styling */
    .chat-box{height:400px;background:var(--bg);border-radius:12px;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
    .message{max-width:80%;padding:8px 12px;border-radius:16px;font-size:14px}
    .message.in{background:#fff;border:1px solid var(--line);align-self:flex-start;border-bottom-left-radius:4px}
    .message.out{background:var(--brand);color:white;align-self:flex-end;border-bottom-right-radius:4px}

    /* Trophy Styling */
    .trophy-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 16px;
    }
    .trophy-item {
        text-align: center;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: var(--bg);
        opacity: 0.5; /* Locked state */
    }
    .trophy-item.unlocked {
        opacity: 1; /* Unlocked state */
        background: #ecfdf5; /* Light green/mint background */
        border-color: #10b981; /* Green border */
    }
    .trophy-icon {
        font-size: 32px;
        margin-bottom: 8px;
        display: block;
    }
    .trophy-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--ink);
        margin-bottom: 4px;
    }
    .trophy-caption {
        font-size: 12px;
        color: var(--muted);
    }

    /* Mission Item Styling */
    .mission-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border: 1px solid var(--line);
        border-radius: 12px;
        margin-bottom: 8px;
        background: #fff;
    }
    .mission-item.complete {
        background: #f0fdf4; /* Very light green */
        border-color: #dcfce7; /* Lighter green border */
        opacity: 0.8;
    }
    .mission-icon {
        font-size: 20px;
        margin-right: 12px;
        line-height: 1;
    }
    .mission-text {
        flex: 1;
        font-weight: 500;
        font-size: 14px;
    }
    .mission-reward {
        font-weight: 700;
        color: #22c55e;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* ********************************************************** */
    /* NEW MOBILE-SPECIFIC STYLES - REFACTORING FOR SMALL SCREENS */
    /* ********************************************************** */
    
    /* Fixed Bottom Navigation - Active on small screens */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: none; /* Hidden by default */
      justify-content: space-around;
      align-items: center;
      background: white;
      border-top: 1px solid var(--line);
      padding: 8px 0;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .bottom-nav button {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 11px; /* Smaller font for mobile tabs */
      color: var(--muted);
      background: transparent;
      border: none;
      padding: 6px 0;
      cursor: pointer;
    }
    .bottom-nav button.active {
      color: var(--primary-mobile); /* Highlight active tab */
    }
    .bottom-nav button .icon {
      font-size: 20px; /* Adjust icon size */
      line-height: 1;
    }
    /* Action Buttons (Find/Offer Ride) on Home Screen */
    .home-action-grid {
      display: none; /* Hidden by default */
    }
    .home-action-button {
      background: var(--primary-mobile);
      color: white;
      border: none;
      border-radius: var(--radius);
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      gap: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .home-action-button .icon {
      font-size: 32px;
      line-height: 1;
    }
    .home-action-button.find-ride {
      background: var(--secondary-mobile);
    }
    /* Your Impact Card */
    .impact-card {
      background: var(--impact-card-bg); 
      border: none; 
      border-radius: var(--radius);
      padding: 16px;
      margin-top: 16px;
      text-align: center;
      display: none; /* Hidden by default */
    }
    .impact-metric {
      flex: 1;
      padding: 0 8px;
    }
    .impact-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--impact-value-color);
      margin-bottom: 4px;
    }
    .impact-label {
      font-size: 13px;
      color: var(--impact-label-color);
    }

    /* Media Query for Mobile (up to 720px width) */
    @media(max-width: 720px){
      /* General Mobile Adjustments */
      .container{ padding: 12px; }
      .section{ padding-block: 12px; }
      
      /* Top Nav Overrides */
      .nav-inner { padding: 10px 12px; border-bottom: none; }
      .nav-inner > div:first-child { 
        flex: 1;
        justify-content: flex-start; /* Move title back to left */
        font-size: 18px; 
      }
      .nav-inner strong { font-size: 18px; }
      .nav-inner .badge { display: none; }
      .nav-inner > div:last-child { display: none; } /* Hide top nav links */
      
      /* Bottom Nav Visibility */
      .bottom-nav { display: flex; }
      main#screens { padding-bottom: 70px; } /* Ensure screens clear bottom nav */

      /* Home Screen Refactor */
      #home.screen .container { padding-bottom: 70px; } /* Clear bottom nav */
      #home .row-5 { display: block; }
      #home #map, 
      #home .row-5 .col, 
      #home .grid-actions, 
      #home .card:last-of-type,
      #home #home-greeting { 
          display: none; /* Hide default desktop home elements */
      }
      #home .home-action-grid, #home .impact-card { 
          display: grid; /* Show mobile-only elements */ 
      }
      #home .impact-card { 
        display: flex; /* Override grid for flex layout */
        box-shadow: none;
      }
      #home .search-container {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      #home .search-container .btn {
          padding: 10px 12px;
          flex-shrink: 0;
      }
      
      /* Standard Screen Overrides */
      .title, #onboard .title, #registerCar .title, #offer .title, #find .title, #messages .title, #rewards .title, #profile .title {
          justify-content: flex-start; /* Align titles left */
          font-size: 20px;
          margin-bottom: 12px;
      }
      .btn.ghost { display: none; } /* Hide in-page back buttons on mobile, let bottom nav handle it */
      .card-h { padding: 12px 16px; font-size: 16px; }
      .card-c { padding: 12px 16px; }
      .grid-2, .grid-3 { grid-template-columns: 1fr; } /* Stack content */
      .input { padding: 12px; }
      .btn.primary, .btn.brand { padding: 12px 16px; font-size: 16px; }
      .row-item { padding: 12px; }

      /* Fix the Rewards layout for mobile stacking */
      #rewards .grid-2 { grid-template-columns: 1fr; }
      #rewards .grid-3 { grid-template-columns: 1fr 1fr 1fr; } /* Keep progress metrics horizontal if possible */
      #rewards .trophy-grid {
          grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
          gap: 12px;
      }
      #rewards .trophy-icon { font-size: 24px; }
      #rewards .trophy-title { font-size: 12px; }

      /* Adjust margins */
      .row, .card { margin-top: 12px; }
    }
  </style>
</head>
<body>
  <div class="nav">
    <div class="nav-inner container">
      <div style="display:flex;align-items:center;gap:8px">
        <strong>RideWise</strong>
        <span class="badge" style="margin-left:8px">üõ°Ô∏è Verified SFU Only</span>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn ghost" data-nav="rewards">Rewards</button>
        <button class="btn ghost" data-nav="messages">Messaging</button>
        <button class="btn ghost" data-nav="profile">Profile</button>
        <button class="btn ghost" data-nav="settings">Settings</button>
      </div>
    </div>
  </div>

  <main id="screens">
    <section id="welcome" class="screen active">
      <div class="container" style="text-align:center;padding-block:48px">
        <span class="badge">‚ú® Smarter Commutes. Cleaner Future.</span>
        <h1 class="h1">Welcome to <span style="color:var(--brand)">RideWise</span></h1>
        <p class="muted" style="max-width:720px;margin:8px auto 0">
          A student-only ride matching app for SFU. Save money, skip parking stress, and cut CO‚ÇÇ ‚Äî one shared commute at a time.
        </p>
        <div style="margin-top:16px;display:flex;justify-content:center;gap:8px">
          <button class="btn primary" data-goto="onboard">Get Started ‚ûú (Verify)</button>
          <button class="btn" data-goto="home">Explore Demo</button>
        </div>

        <div class="row grid-3" style="margin-top:24px;text-align:left">
          <div class="card">
            <div class="card-h"><strong>üåø Lower Emissions</strong></div>
            <div class="card-c muted">Track CO‚ÇÇ saved each trip and compete on campus leaderboards.</div>
          </div>
          <div class="card">
            <div class="card-h"><strong>üí∏ Split Costs</strong></div>
            <div class="card-c muted">Transparent, small cost-share estimates keep things fair and friendly.</div>
          </div>
          <div class="card">
            <div class="card-h"><strong>üõ°Ô∏è Trusted Community</strong></div>
            <div class="card-c muted">SFU email verification, preferences, and ratings build confidence.</div>
          </div>
        </div>
      </div>
    </section>

    <section id="onboard" class="screen">
      <div class="container section">
        <h2 class="title" style="display:flex;align-items:center;gap:8px">‚Üê <button class="btn ghost" data-goto="welcome">Back</button> Set up your commuter profile</h2>
        
        <div class="card" style="margin-top:12px">
            <div class="card-h"><strong>üõ°Ô∏è Student Verification (SFU)</strong></div>
            <div class="card-c">
                <div class="label">Full Name (used for your profile)</div>
                <input class="input" id="onboardName" placeholder="e.g., Alex Chan" style="margin-bottom:12px" />
                
                <div class="label">SFU Email (for verification)</div>
                <input class="input" id="onboardEmail" placeholder="e.g., xxx@sfu.ca" style="margin-bottom:12px" />
                
                <div class="label">SFU Student ID (for mock verification)</div>
                <input class="input" id="onboardStudentId" placeholder="e.g., 301XXXXXX" />
                <p class="muted" style="font-size:14px;margin-top:6px">This step builds community trust and is required to join/post rides.</p>
            </div>
        </div>
        
        <div class="row grid-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><strong>How do you want to use RideWise?</strong></div>
            <div class="card-c">
              <div class="grid-2">
                <div class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                  <div style="display:flex;align-items:center;gap:8px">üöó <div><div class="title">Offer rides (Driver)</div><div class="muted" style="font-size:14px">Share seats when it works for you.</div></div></div>
                  <input id="asDriver" type="checkbox" class="switch" />
                </div>
                <div class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                  <div style="display:flex;align-items:center;gap:8px">üë§ <div><div class="title">Find rides (Rider)</div><div class="muted" style="font-size:14px">Match with nearby drivers to SFU.</div></div></div>
                  <input id="asRider" type="checkbox" class="switch" checked />
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><strong>Preferences</strong></div>
            <div class="card-c">
              <div class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
                <span>Carpool Mode (show me as available)</span>
                <input id="carpoolMode" type="checkbox" class="switch" checked />
              </div>
              <div class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
                <span>Friends-only mode</span>
                <input id="friendsOnly" type="checkbox" class="switch" />
              </div>
              <div class="pill">
                <div class="label">Gender preference</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" data-gender="any">Any</button>
                  <button class="btn" data-gender="female">Female</button>
                  <button class="btn" data-gender="male">Male</button>
                </div>
              </div>
              <div style="display:flex;justify-content:end;margin-top:12px">
                <button class="btn primary" onclick="completeOnboarding()">**Verify & Continue ‚ûú**</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section id="registerCar" class="screen">
      <div class="container section">
        <h2 class="title" style="display:flex;align-items:center;gap:8px">‚Üê <button class="btn ghost" data-goto="onboard">Back</button> Register your car</h2>
        <p class="muted" style="margin-top:4px">This helps riders feel safe and confident knowing the vehicle details for pickup.</p>
        
        <div class="card" style="margin-top:12px">
          <div class="card-h"><strong>Vehicle Details</strong></div>
          <div class="card-c">
            <div style="margin-bottom:12px">
              <div class="label">Car Make</div>
              <input class="input" id="carMake" placeholder="e.g., Honda" />
            </div>
            <div style="margin-bottom:12px">
              <div class="label">Car Model</div>
              <input class="input" id="carModel" placeholder="e.g., Civic" />
            </div>
            <div style="margin-bottom:12px">
              <div class="label">License Plate (for mock verification)</div>
              <input class="input" id="carPlate" placeholder="e.g., ABC 123" />
              <p class="muted" style="font-size:14px;margin-top:6px">The plate is only shown to matched riders just before pickup.</p>
            </div>

            <div style="display:flex;justify-content:end;margin-top:12px">
              <button class="btn primary" onclick="completeCarRegistration()">**Save & Continue ‚ûú**</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="home" class="screen">
      <div class="container section">
        <div id="home-greeting">
            </div>
        
        <div class="search-container" style="display:flex;gap:8px">
          <div style="flex:1">
            <input id="search" class="input" placeholder="Search driver, pickup, or drop-off" />
          </div>
          <button class="btn" data-goto="find">Filters</button>
        </div>
        
        <div class="home-action-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
            <button class="home-action-button" data-goto="offer">
                <span class="icon">üöó</span>
                Offer a Ride
            </button>
            <button class="home-action-button find-ride" data-goto="find">
                <span class="icon">üë§</span>
                Find a Ride
            </button>
        </div>

        <div class="impact-card">
            <div class="impact-metric">
                <div class="impact-value" id="co2Big">55.8</div>
                <div class="impact-label">kg CO‚ÇÇ saved</div>
            </div>
            <div style="width:1px; background: #dcdcdc;"></div>
            <div class="impact-metric">
                <div class="impact-value" id="points">250</div>
                <div class="impact-label">WisePoints</div>
            </div>
        </div>
        
        <div class="card" style="margin-top:16px;">
            <div class="card-h"><strong>Upcoming Rides (Next 24h)</strong></div>
            <div class="card-c" id="rideList">
                <div class="muted" style="text-align:center; padding: 24px;">No upcoming rides found in your area.</div>
            </div>
        </div>

        <div class="row row-5" style="margin-top:12px">
          <div class="map" id="map">
            <div class="badge map-chip">üìç SFU Burnaby Campus Area (Live Map View)</div>
            <iframe
              width="100%"
              height="100%"
              frameborder="0"
              style="border:0;"
              referrerpolicy="no-referrer-when-downgrade"
              src="https://maps.google.com/maps?width=100%&height=100%&hl=en&q=SFU+Burnaby+Campus&t=&z=14&ie=UTF8&iwloc=B&output=embed"
              allowfullscreen>
            </iframe>
          </div>

          <div class="col">
            <div class="card">
              <div class="card-h"><strong>Available rides</strong> <span class="muted" id="count" style="margin-left:auto"></span></div>
              <div class="card-c" id="rideListDesktop"></div> </div>

            <div class="grid-actions" style="margin-top:12px">
              <button class="btn brand" data-goto="offer">Ôºã Offer a ride</button>
              <button class="btn" data-goto="find">‚Ü∫ Find a ride</button>
            </div>

            <div class="card" style="margin-top:12px">
              <div class="card-c" style="display:flex;align-items:center;justify-content:space-between">
                <div class="muted">
                  <div class="title">Campus impact</div>
                  RideWise users saved <b><span id="co2Desktop">18.4</span> kg</b> CO‚ÇÇ
                </div>
                <button class="btn ghost" data-goto="rewards">View rewards</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="offer" class="screen">
      <div class="container section">
        <div style="display:flex;align-items:center;gap:8px" class="title">‚Üê <button class="btn ghost" data-goto="home">Back</button> Offer a ride</div>
        <div class="card" style="margin-top:12px">
          <div class="card-h"><strong>Trip details</strong></div>
          <div class="card-c">
            <div class="grid-2">
              <div>
                <div class="label">From (Pickup Location)</div>
                <select class="input" id="offerFrom">
                    <option value="Production Way‚ÄìUniversity Station" selected>Production Way‚ÄìUniversity Station</option>
                    <option value="Lougheed Town Centre">Lougheed Town Centre</option>
                    <option value="Surrey Central">Surrey Central</option>
                    <option value="Metrotown Station">Metrotown Station</option>
                    <option value="Burquitlam Station">Burquitlam Station</option>
                    <option value="Custom">Other (Type below)</option>
                </select>
              </div>
              <div>
                <div class="label">To (Drop-off Campus)</div>
                <select class="input" id="offerTo">
                    <option value="SFU Burnaby" selected>SFU Burnaby</option>
                    <option value="SFU Surrey">SFU Surrey</option>
                    <option value="SFU Vancouver">SFU Vancouver</option>
                    <option value="Custom">Other (Type below)</option>
                </select>
              </div>
            </div>
            <div class="grid-2 hidden" id="customLocations">
                <div><input class="input" id="offerFromCustom" placeholder="Type custom pickup location" /></div>
                <div><input class="input" id="offerToCustom" placeholder="Type custom drop-off location" /></div>
            </div>

            <div class="grid-3" style="margin-top:8px">
              <div>
                <div class="label">Departure time</div>
                <input type="time" class="input" id="offerTime" value="09:00" />
              </div>
              <div>
                <div class="label">Seats</div>
                <input type="number" class="input" id="offerSeats" min="1" max="4" value="2" />
              </div>
              <div>
                <div class="label">Cost share ($ est.)</div>
                <input type="number" class="input" id="offerCost" min="0" step="0.5" value="2" />
              </div>
            </div>
            <div style="margin-top:8px">
              <div class="label">Notes (optional)</div>
              <textarea class="input" id="offerNotes" rows="3" placeholder="e.g., Quiet ride, no food please"></textarea>
            </div>
            <div class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px">
              <div>
                <div class="title" style="font-weight:600">Friends-only mode</div>
                <div class="muted" style="font-size:14px">Only show to people you follow or have ridden with</div>
              </div>
              <input id="offerFriends" type="checkbox" class="switch" />
            </div>
            <div style="display:flex;justify-content:end;gap:8px;margin-top:12px">
              <button class="btn" data-goto="home">Cancel</button>
              <button class="btn primary" id="postRide">Post ride</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
            <div class="card-h">
                <div style="display:flex;align-items:center;gap:8px">üìÖ <strong>Schedule & Parking Benefits</strong></div>
            </div>
            <div class="card-c">
                <div style="margin-bottom:12px">
                    <div class="label">Daily Parking Rate Comparison</div>
                    <div class="pill" style="display:flex;align-items:center;justify-content:space-between;padding:12px">
                        <div class="title" style="font-size:16px;color:var(--brand-ink)">Standard Daily Rate</div>
                        <div style="font-size:16px"><strong>$8.00 / day</strong></div>
                    </div>
                    <div class="pill" style="display:flex;align-items:center;justify-content:space-between;padding:12px;margin-top:8px;background:#d1fae5">
                        <div class="title" style="font-size:16px;color:#059669">RideWise Carpool Rate</div>
                        <div style="font-size:16px"><strong>$4.00 / day</strong></div>
                    </div>
                    <p class="muted" style="font-size:14px;margin-top:8px">**Save 50%** when you park with verified riders!</p>
                </div>
                
                <div class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:12px">
                    <div>
                      <div class="title" style="font-weight:600">Recurring Ride (Carpool Group)</div>
                      <div class="muted" style="font-size:14px">Set this ride to auto-post every Mon/Wed/Fri</div>
                    </div>
                    <input id="offerRecurring" type="checkbox" class="switch" />
                </div>
            </div>
        </div>
        
      </div>
    </section>

    <section id="find" class="screen">
      <div class="container section">
        <div style="display:flex;align-items:center;gap:8px" class="title">‚Üê <button class="btn ghost" data-goto="home">Back</button> Find a ride</div>
        <div class="card" style="margin-top:12px">
          <div class="card-h"><strong>Filters</strong></div>
          <div class="card-c">
            <div class="grid-3">
              <div>
                <div class="label">Earliest time</div>
                <input type="time" class="input" id="filterTime" />
              </div>
              <div>
                <div class="label">Gender preference</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" data-gender-filter="any">Any</button>
                  <button class="btn" data-gender-filter="female">Female</button>
                  <button class="btn" data-gender-filter="male">Male</button>
                </div>
              </div>
              <div>
                <div class="label">Filter by Course Match</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" data-course-filter="none">All Rides</button>
                  <button class="btn" data-course-filter="cmpt300">CMPT 300</button>
                  <button class="btn" data-course-filter="bus343">BUS 343</button>
                </div>
              </div>
            </div>
            <div style="display:flex;justify-content:end;margin-top:12px">
              <button class="btn primary" data-apply-filters>Apply</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="card-h"><strong>Results</strong> <span class="muted" id="resultsCount" style="margin-left:auto"></span></div>
          <div class="card-c" id="results"></div>
        </div>
      </div>
    </section>

    <section id="details" class="screen">
      <div class="container section">
        <div style="display:flex;align-items:center;gap:8px" class="title" id="detailsHeader"></div>
        <div class="card" style="margin-top:12px" id="detailsCard">
          <div class="card-c">No ride selected.</div>
        </div>
      </div>
    </section>
    
    <section id="messages" class="screen">
      <div class="container section">
        <h2 class="title" style="display:flex;align-items:center;gap:8px">‚Üê <button class="btn ghost" data-goto="home">Back</button> Messaging & Chat</h2>
        <p class="muted" style="margin-top:4px">Private chats with drivers/riders you've matched with, and group chats for your rides.</p>
        
        <div class="row grid-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><strong>Recent Chats</strong></div>
            <div class="card-c">
                <button class="row-item" style="margin-bottom:8px" onclick="showChat('chat-maya')">
                  <div class="avatar" style="background:#fef3c7">AT</div>
                  <div style="flex:1">
                    <div class="title">Annika Tan <span class="badge" style="background:#d1fae5">1 new</span></div>
                    <div class="muted" style="font-size:14px">Just checking on the pickup spot...</div>
                  </div>
                  <span>></span>
                </button>
                <button class="row-item" style="margin-bottom:8px" onclick="showChat('chat-alex')">
                  <div class="avatar" style="background:#ffe4e6">KS</div>
                  <div style="flex:1">
                    <div class="title">Kaidin SD</div>
                    <div class="muted" style="font-size:14px">See you at 8:40!</div>
                  </div>
                  <span>></span>
                </button>
                <button class="row-item" onclick="showChat('chat-group')">
                  <div class="avatar">GS</div>
                  <div style="flex:1">
                    <div class="title">SFU Bus Loop Group Chat</div>
                    <div class="muted" style="font-size:14px">Rex: Running 2 mins late, guys.</div>
                  </div>
                  <span>></span>
                </button>
            </div>
          </div>
          <div class="card">
            <div class="card-h"><strong>New Message</strong></div>
            <div class="card-c">
              <div class="label">Select Contact or Start Group Chat</div>
              <input class="input" id="newChatInput" placeholder="Search contacts (e.g., Rex, Annika)" />
              <button class="btn primary block" style="margin-top:12px" onclick="initiateNewChat()">Start Chat</button>
            </div>
          </div>
        </div>
      </div>
    </section>


    <section id="rewards" class="screen">
      <div class="container section">
        <div style="display:flex;align-items:center;gap:8px" class="title">‚Üê <button class="btn ghost" data-goto="home">Back</button> Rewards & Impact</div>
        
        <div class="row grid-2" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><strong>Your progress</strong></div>
            <div class="card-c">
              <div class="grid-3">
                <div class="pill" style="text-align:center">
                  <div class="muted">WisePoints</div>
                  <div class="title metric-value" id="points">120</div>
                </div>
                <div class="pill" style="text-align:center">
                  <div class="muted">CO‚ÇÇ saved</div>
                  <div class="title metric-value"><span id="co2Big">18.4</span> kg</div>
                </div>
                <div class="pill" style="text-align:center">
                  <div class="muted">Badges</div>
                  <div class="title metric-value">3</div>
                </div>
              </div>
              <div class="grid-2" style="margin-top:12px">
                <div class="k full-width">Redeem: $5 coffee (50 pts) ‚Ä¢ $10 dining (100 pts) ‚Ä¢ Parking lottery (25 pts)</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-h"><strong>Campus leaderboard</strong></div>
            <div class="card-c" id="leaderboard"></div>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
            <div class="card-h"><strong>Daily Missions</strong></div>
            <div class="card-c" id="missionsBar">
                </div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="card-h"><strong>Referral Bonus</strong></div>
            <div class="card-c" style="text-align:center">
                <p class="title" style="margin-bottom:8px">Invite a friend and get 50 WisePoints each!</p>
                <div class="pill" style="display:inline-flex;align-items:center;gap:12px">
                    <span class="muted">Your Code:</span>
                    <strong id="referralCodeDisplay">SFU-RIDE-JANE</strong>
                    <button class="btn primary">Share</button>
                </div>
                <p class="muted" style="font-size:14px;margin-top:8px">Earn unlimited rewards when your friends complete their first ride.</p>
            </div>
        </div>

        <div class="card" style="margin-top:16px">
            <div class="card-h"><strong>Environmental Trophies</strong></div>
            <div class="card-c">
                <div class="trophy-grid" id="trophyGrid">
                    </div>
            </div>
        </div>

      </div>
    </section>

    <section id="profile" class="screen">
      <div class="container section">
        <div style="display:flex;align-items:center;gap:8px" class="title">‚Üê <button class="btn ghost" data-goto="home">Back</button> Profile & Preferences</div>
        
        <div class="card" style="margin-top:12px">
            <div class="card-h"><strong>Complete Your Profile</strong></div>
            <div class="card-c" style="display:flex;align-items:center;gap:16px">
                <div style="flex:1">
                    <div class="title" style="font-weight:600">Finish setting up your profile for higher trust and more matches.</div>
                    <div class="muted" style="font-size:14px;margin-top:4px">Remaining steps: Add a photo, verify car details, set bio.</div>
                </div>
                <button class="btn primary">Update Photo (Mock)</button>
            </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><strong>Your profile</strong></div>
            <div class="card-c">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                <div class="avatar" id="profileAvatar">GR</div>
                <div>
                  <div class="title" id="profileName">Guest Rider</div>
                  <div class="muted" style="font-size:14px">Rating: 4.9 ‚Ä¢ 12 rides</div>
                </div>
              </div>
              <div class="grid-2">
                <label class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                  <span>Carpool mode</span>
                  <input type="checkbox" class="switch" id="pfCarpool" checked />
                </label>
                <label class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                  <span>Friends-only</span>
                  <input type="checkbox" class="switch" id="pfFriends" />
                </label>
              </div>
              <div class="pill" style="margin-top:8px">
                <div class="label">Gender preference</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" data-gender="any">Any</button>
                  <button class="btn" data-gender="female">Female</button>
                  <button class="btn" data-gender="male">Male</button>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-h"><strong>Ride etiquette (What riders should know)</strong></div>
            <div class="card-c" id="etiquetteOptions" style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" data-etiquette="Quiet">Quiet</button>
              <button class="btn" data-etiquette="Music OK">Music OK</button>
              <button class="btn" data-etiquette="No food">No food</button>
              <button class="btn" data-etiquette="Trunk space limited">Trunk space limited</button>
              <button class="btn" data-etiquette="Mask friendly">Mask friendly</button>
              <button class="btn" data-etiquette="Women-only">Women-only (if preferred)</button>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <div class="card-h"><strong>Favorite Riders/Drivers</strong></div>
          <div class="card-c" id="favoritesList">
              <button class="row-item" style="margin-bottom:8px">
                  <div class="avatar" style="background:#ffe4e6">KS</div>
                  <div style="flex:1">
                      <div class="title">Kaidin SD</div>
                      <div class="muted" style="font-size:14px">Driver ‚Ä¢ Rating: 4.8</div>
                  </div>
                  <button class="btn ghost">Remove</button>
              </button>
              <button class="row-item">
                  <div class="avatar" style="background:#fef3c7">AT</div>
                  <div style="flex:1">
                      <div class="title">Annika Tan</div>
                      <div class="muted" style="font-size:14px">Rider ‚Ä¢ Rating: 5.0</div>
                  </div>
                  <button class="btn ghost">Remove</button>
              </button>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <div class="card-h"><strong>Contacts & Friends</strong></div>
          <div class="card-c" id="contactsList">
              <p class="muted" style="font-size:14px">Friends are automatically trusted and exempt from "Friends-only mode" rides.</p>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <div class="card-h"><strong>Emergency Contact</strong></div>
          <div class="card-c">
            <p class="muted" style="font-size:14px;margin-bottom:12px">Your emergency contact will be notified only if the in-app SOS feature is activated during a ride.</p>
            <div style="margin-bottom:12px">
              <div class="label">Name</div>
              <input class="input" id="ecName" placeholder="e.g., Mom" value="Sarah Doe" />
            </div>
            <div style="margin-bottom:12px">
              <div class="label">Phone Number</div>
              <input type="tel" class="input" id="ecPhone" placeholder="e.g., 555-123-4567" value="555-123-4567" />
            </div>
            <div style="display:flex;justify-content:end">
                <button class="btn primary" onclick="updateEmergencyContact()">Save Contact</button>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section id="settings" class="screen">
      <div class="container section">
        <div style="display:flex;align-items:center;gap:8px" class="title">‚Üê <button class="btn ghost" data-goto="home">Back</button> Settings</div>
        <div class="row" style="margin-top:12px">
          <div class="card">
            <div class="card-h"><strong>Privacy</strong></div>
            <div class="card-c muted">RideWise is SFU-only with email verification. We never sell personal data. Aggregate, anonymized commute stats may be shared with SFU for sustainability reporting.</div>
          </div>
          <div class="card">
            <div class="card-h"><strong>Notifications</strong></div>
            <div class="card-c">
              <label class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px"><span>Ride requests</span><input type="checkbox" class="switch" checked></label>
              <label class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px"><span>Messages</span><input type="checkbox" class="switch"></label>
              <label class="pill" style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px"><span>Rewards & challenges</span><input type="checkbox" class="switch"></label>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <div class="bottom-nav">
      <button data-nav="home" class="active">
          <span class="icon">üè†</span>
          <span>Home</span>
      </button>
      <button data-nav="rewards">
          <span class="icon">‚ú®</span>
          <span>Rewards</span>
      </button>
      <button data-nav="messages">
          <span class="icon">üí¨</span>
          <span>Messages</span>
      </button>
      <button data-nav="profile">
          <span class="icon">üë§</span>
          <span>Profile</span>
      </button>
  </div>


  <script>
    // -------- State --------
    const state = {
      screen: 'welcome',
      userName: 'Guest Rider',
      isVerified: false,
      asDriver: false,
      asRider: true,
      carpoolMode: true,
      friendsOnly: false,
      genderPref: 'any',
      query: '',
      timeFilter: '',
      courseFilter: 'none', 
      selectedRideId: null,
      selectedChatId: null, 
      points: 250, // Increased mock points
      co2SavedKg: 55.8, // Increased mock CO2 saved
      ridesCompleted: 8, // New mission stat
      newFriendsRiddenWith: 1, // New mission stat
      carMake: '',
      carModel: '',
      rideEtiquette: ['Quiet', 'Mask friendly'], 
      emergencyContact: { name: 'Sarah Doe', phone: '555-123-4567' }, 
      
      // MOCK DATA
      contacts: [
        {name: 'Kaidin SD', initials: 'KS', isFriend: true, rating: 4.8},
        {name: 'Annika Tan', initials: 'AT', isFriend: true, rating: 5.0},
        {name: 'Rex F', initials: 'RF', isFriend: false, rating: 4.6},
        {name: 'Lucas Li', initials: 'LL', isFriend: false, rating: 4.7}
      ],
      userCourses: ['cmpt300', 'bus343'] 
    };

    /** Mock rides seeded along the Production Way ‚ûú SFU Burnaby corridor */
    const RIDES = [
      {id:'r1', driver:'Kaidin SD', driverInitials:'KS', rating:4.8, seats:2, departTime:'08:40', from:'Production Way‚ÄìUniversity Station', to:'SFU Burnaby', costShare:2, notes:'Quiet ride, no food please', gender:'any', car:'Honda Civic', etiquette:['Quiet', 'No food'], courses: ['cmpt300']}, 
      {id:'r2', driver:'Annika Tan', driverInitials:'AT', rating:5.0, seats:1, departTime:'09:10', from:'Lougheed Town Centre', to:'SFU Burnaby', costShare:3, notes:'Music okay, can chat', gender:'female', car:'Toyota Corolla', etiquette:['Music OK', 'Women-only'], courses: ['bus343']}, 
      {id:'r3', driver:'Lucas Li', driverInitials:'LL', rating:4.6, seats:3, departTime:'10:05', from:'Metrotown Station', to:'SFU Burnaby', costShare:2, notes:'Friends-only mode OFF', gender:'any', car:'Ford Escape', etiquette:['Mask friendly', 'Trunk space limited'], courses: []}
    ];

    /** Mock chats */
    const CHATS = { 
        'chat-maya': {
            partner: 'Annika Tan',
            initials: 'AT',
            color: '#fef3c7',
            messages: [
                {type: 'in', text: 'Hey, I just joined your ride to SFU Burnaby!'},
                {type: 'out', text: 'Awesome! Glad to have you. Just confirming pickup is at Lougheed Town Centre at 9:10.'},
                {type: 'in', text: 'Yep, sounds good! Just checking on the pickup spot...'}
            ]
        },
        'chat-alex': {
            partner: 'Kaidin SD',
            initials: 'KS',
            color: '#ffe4e6',
            messages: [
                {type: 'in', text: 'See you at 8:40!'},
                {type: 'out', text: 'Perfect timing, traffic should be light then. See you!'}
            ]
        },
        'chat-group': {
            partner: 'SFU Bus Loop Group Chat',
            initials: 'GS',
            color: '#f1f5f9',
            messages: [
                {type: 'in', sender: 'Rex', text: 'Running 2 mins late, guys.'},
                {type: 'in', sender: 'Kaidin', text: 'No worries!'}
            ]
        }
    };

    /** Environmental Trophies */
    const TROPHIES = [
        { id: 1, icon: 'S', title: 'Seedling', caption: '10 kg CO‚ÇÇ saved', threshold: 10 }, // Changed from üå±
        { id: 2, icon: 'T', title: 'Sapling', caption: '50 kg CO‚ÇÇ saved', threshold: 50 }, // Changed from üå≥
        { id: 3, icon: 'F', title: 'Forest Starter', caption: '100 kg CO‚ÇÇ saved', threshold: 100 }, // Changed from üå≤
        { id: 4, icon: 'E', title: 'Eco Champion', caption: '500 kg CO‚ÇÇ saved', threshold: 500 } // Changed from üåé
    ];
    
    /** Daily Missions */
    const MISSIONS = [ 
        { id: 1, icon: 'H', text: 'Share a ride (complete 1 carpool)', reward: 20, completed: state.ridesCompleted > 0, buttonText: 'Find Ride' }, // Changed from ü§ù
        { id: 2, icon: 'L', text: 'Save 1 kg of CO‚ÇÇ (daily bonus)', reward: 5, completed: state.co2SavedKg > 55, buttonText: 'View Impact' }, // Changed from üåø
        { id: 3, icon: 'F', text: 'Make a new friend (ride with a new contact)', reward: 30, completed: state.newFriendsRiddenWith > 0, buttonText: 'Invite Friend' } // Changed from ü•≥
    ];


    // -------- Emergency Contact Logic --------
    function updateEmergencyContact() {
        const name = document.getElementById('ecName').value.trim();
        const phone = document.getElementById('ecPhone').value.trim();
        
        if (!name || !phone) {
            alert('Please enter both a name and a phone number for your emergency contact.');
            return;
        }
        
        state.emergencyContact = { name, phone };
        alert(`Emergency contact (${name}) updated.`);
    }

    // -------- Chat Initiation Logic --------
    function initiateNewChat() {
        const query = document.getElementById('newChatInput').value.trim();
        if (!query) {
            alert('Please enter a contact name to start a new chat.');
            return;
        }

        // Mock Search: Find a contact or mock a new one
        const contact = state.contacts.find(c => c.name.toLowerCase().includes(query.toLowerCase()));

        if (contact) {
            // Found existing contact, use a dynamic chat ID
            const newChatId = `chat-${contact.initials.toLowerCase()}-${Date.now()}`;
            
            // Add a mock new chat to CHATS object (assuming a simple initial message)
            CHATS[newChatId] = {
                partner: contact.name,
                initials: contact.initials,
                color: contact.initials === 'AT' ? '#fef3c7' : (contact.initials === 'KS' ? '#ffe4e6' : '#f1f5f9'),
                messages: [
                    {type: 'out', text: `Hello ${contact.name.split(' ')[0]}, let's connect for the carpool!`}
                ]
            };
            
            showChat(newChatId);

        } else if (query.toLowerCase().includes('rex')) {
             // Mock starting a chat with Rex F, who isn't a "Friend" but is a contact
            const newChatId = `chat-rf-${Date.now()}`;
            
            CHATS[newChatId] = {
                partner: 'Rex F',
                initials: 'RF',
                color: '#f1f5f9',
                messages: [
                    {type: 'out', text: 'Hey Rex, I saw your post. Can I join your ride to campus?'}
                ]
            };
            
            showChat(newChatId);
        } else {
             alert(`Could not find a match for "${query}". Please try "Rex", "Kaidin", or "Annika" to start a new chat. (This is a demo search.)`);
        }
        document.getElementById('newChatInput').value = ''; // Clear input
    }
    
    // -------- Custom Location Toggle Logic --------
    function setupOfferScreenListeners() {
        const fromSelect = document.getElementById('offerFrom');
        const toSelect = document.getElementById('offerTo');
        const customContainer = document.getElementById('customLocations');
        
        function toggleCustomFields() {
            const isCustomSelected = fromSelect.value === 'Custom' || toSelect.value === 'Custom';
            customContainer.classList.toggle('hidden', !isCustomSelected);
        }

        fromSelect.addEventListener('change', toggleCustomFields);
        toSelect.addEventListener('change', toggleCustomFields);
        
        // Initial check on load
        toggleCustomFields();
    }
    
    // -------- Onboarding/Verification Logic --------
    function completeOnboarding(){
      const name = document.getElementById('onboardName').value.trim();
      const studentId = document.getElementById('onboardStudentId').value.trim();
      const email = document.getElementById('onboardEmail').value.trim(); // NEW: Get email
      const driverMode = document.getElementById('asDriver').checked;
      const riderMode = document.getElementById('asRider').checked;

      if(!name || !studentId || !email){ // UPDATED: Check for email
        alert('Please enter your full name, SFU Student ID, and SFU Email to verify.');
        return;
      }
      if(!driverMode && !riderMode){
        alert('Please select at least one mode (Driver or Rider).');
        return;
      }

      // MOCK VERIFICATION SUCCESS
      state.userName = name;
      state.isVerified = true;
      state.asDriver = driverMode;
      state.asRider = riderMode;
      
      // Update gender preference if needed
      document.querySelectorAll('#onboard [data-gender]').forEach(btn=>{
          if(btn.classList.contains('primary')){
              state.genderPref = btn.getAttribute('data-gender');
          }
      });

      alert(`Verification successful! Welcome back, ${state.userName.split(' ')[0]}!`);
      
      // REDIRECT LOGIC: If driver mode is ON, go to car registration, otherwise go home.
      if(state.asDriver){
        show('registerCar');
      } else {
        show('home');
      }
    }
    
    // -------- Car Registration Logic --------
    function completeCarRegistration(){
      const make = document.getElementById('carMake').value.trim();
      const model = document.getElementById('carModel').value.trim();
      const plate = document.getElementById('carPlate').value.trim();

      if(!make || !model || !plate){
        alert('Please enter your car make, model, and license plate.');
        return;
      }
      
      state.carMake = make;
      state.carModel = model;
      
      alert(`Car registered: ${make} ${model}. You are now ready to offer rides!`);
      show('home');
    }

    // -------- Etiquette Listener Logic --------
    function setupEtiquetteListeners() {
        document.querySelectorAll('#etiquetteOptions [data-etiquette]').forEach(btn => {
            const etiquette = btn.getAttribute('data-etiquette');

            // 1. Set initial state (primary class)
            if (state.rideEtiquette.includes(etiquette)) {
                btn.classList.add('primary');
            } else {
                btn.classList.remove('primary');
            }
            
            // 2. Clear previous listeners before adding a new one (important for re-renders)
            btn.onclick = null;

            // 3. Attach toggle listener
            btn.onclick = () => {
                if (state.rideEtiquette.includes(etiquette)) {
                    // Remove if already present
                    state.rideEtiquette = state.rideEtiquette.filter(e => e !== etiquette);
                    btn.classList.remove('primary');
                } else {
                    // Add if not present
                    state.rideEtiquette.push(etiquette);
                    btn.classList.add('primary');
                }
            };
        });
    }


    // -------- Routing --------
    function updateBottomNav(screen) {
        document.querySelectorAll('.bottom-nav button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-nav') === screen) {
                btn.classList.add('active');
            }
        });
    }
    
    function show(screen){
      if(screen==='messages'){
          state.selectedChatId = null; // Clear selected chat when going to message list
      }
      state.screen = screen;
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(screen).classList.add('active');
      
      updateBottomNav(screen); // Update bottom nav indicator
      
      // Call render functions for screens that need dynamic updates
      if(screen==='home'){ renderHome(); } 
      if(screen==='find'){ renderFind(); }
      if(screen==='rewards'){ renderRewards(); }
      if(screen==='details'){ 
          if(state.selectedChatId){
              renderChatDetails(); // NEW: Render chat if selected
          } else {
              renderDetails(); // Existing ride details
          }
      }
      if(screen==='profile'){ renderProfile(); } 
      if(screen==='offer'){ setupOfferScreenListeners(); } 
    }

    // nav buttons
    document.querySelectorAll('[data-goto]').forEach(btn=>btn.addEventListener('click', e=>{
      const to = e.currentTarget.getAttribute('data-goto');
      show(to);
    }));
    document.querySelectorAll('[data-nav]').forEach(btn=>btn.addEventListener('click', e=>{
      const to = e.currentTarget.getAttribute('data-nav');
      show(to);
    }));
    
    // NEW: Chat initiation function
    function showChat(chatId) {
        state.selectedRideId = null; // Clear selected ride
        state.selectedChatId = chatId;
        show('details');
    }

    // gender pref buttons (onboard and profile)
    document.querySelectorAll('[data-gender]').forEach(btn=>btn.addEventListener('click', e=>{
      // Reset button styles in the same group
      const group = e.currentTarget.parentElement;
      group.querySelectorAll('.btn').forEach(b=>b.classList.remove('primary'));
      
      // Set the clicked button's style
      e.currentTarget.classList.add('primary');
      
      // Update state in case it's on a non-onboarding screen
      if(state.screen !== 'onboard'){
        state.genderPref = e.currentTarget.getAttribute('data-gender');
      }
    }));

    // renderProfile function
    function renderProfile(){
        const nameEl = document.getElementById('profileName');
        const avatarEl = document.getElementById('profileAvatar');
        const contactsListEl = document.getElementById('contactsList');
        
        if(state.isVerified){
            const initials = state.userName.split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2);
            if(nameEl) nameEl.textContent = state.userName;
            if(avatarEl) avatarEl.textContent = initials;
            
            // Sync preferences
            document.getElementById('pfCarpool').checked = state.carpoolMode;
            document.getElementById('pfFriends').checked = state.friendsOnly;
        } else {
             if(nameEl) nameEl.textContent = 'Guest Rider';
             if(avatarEl) avatarEl.textContent = 'GR';
        }
        
        // Setup etiquette buttons on profile load
        setupEtiquetteListeners();
        
        // Render Contacts
        contactsListEl.innerHTML = ''; // Clear previous content
        contactsListEl.innerHTML = `<p class="muted" style="font-size:14px;margin-bottom:8px">Friends are automatically trusted and exempt from "Friends-only mode" rides.</p>`;

        state.contacts.forEach(c => {
            const row = document.createElement('div');
            row.className = 'row-item';
            const friendStatus = c.isFriend ? 'Friend' : 'Contact';
            const friendBadge = c.isFriend ? '<span class="badge" style="background:#d1fae5">‚òÖ Friend</span>' : '';
            row.innerHTML = `<div class="avatar">${c.initials}</div>
              <div style="flex:1">
                <div class="title" style="display:flex;align-items:center;gap:8px">${c.name} ${friendBadge}</div>
                <div class="muted" style="font-size:14px">Rating: ${c.rating.toFixed(1)}</div>
              </div>
              <button class="btn ghost">${c.isFriend ? 'Unfriend' : 'Add Friend'}</button>`;
            contactsListEl.appendChild(row);
        });
        
        // Sync Emergency Contact Fields
        if(state.emergencyContact){
            document.getElementById('ecName').value = state.emergencyContact.name;
            document.getElementById('ecPhone').value = state.emergencyContact.phone;
        }
    }

    // -------- Filtering logic --------
    function getFilteredRides(){
      return RIDES.filter(r=>{
        // Filter by location *or* driver name in search bar (used on home screen)
        const matchesQuery = state.query ? (r.driver + ' ' + r.from + ' ' + r.to).toLowerCase().includes(state.query.toLowerCase()) : true;
        const matchesTime = state.timeFilter ? r.departTime >= state.timeFilter : true;
        const matchesGender = state.genderPref==='any' ? true : r.gender===state.genderPref;
        
        // NEW: Filter by Course Match (used on find screen)
        const matchesCourse = state.courseFilter === 'none' ? true : r.courses.some(c => state.userCourses.includes(c));

        return matchesQuery && matchesTime && matchesGender && matchesCourse;
      });
    }

    // -------- Home rendering --------
    function renderHome(){
      // Greeting logic
      const greetingEl = document.getElementById('home-greeting');
      if(greetingEl){
        if(state.isVerified){
          // For mobile view, keep this simplified and let the action buttons dominate
          if (window.innerWidth > 720) {
              greetingEl.innerHTML = `<h2 class="h1" style="font-size:32px;">Welcome back, ${state.userName.split(' ')[0]}!</h2><div class="muted">Find your commute or post a ride.</div>`;
          } else {
              greetingEl.innerHTML = ``; // Hide the big greeting on mobile as per design change
          }
        } else {
          greetingEl.innerHTML = `<h2 class="h1" style="font-size:32px;">Welcome to RideWise!</h2><div class="muted">Please <button class="btn ghost" style="padding:0" data-goto="onboard">verify your profile</button> to post or join rides.</div>`;
        }
      }

      // bind search (only applies query filter for now, time/gender handled on find screen)
      const search = document.getElementById('search');
      search.value = state.query;
      search.oninput = (e)=>{ state.query = e.target.value; renderHome(); };

      const list = document.getElementById('rideList');
      const count = document.getElementById('count');
      const listDesktop = document.getElementById('rideListDesktop');
      
      // Update global impact stats
      document.getElementById('co2Big').textContent = state.co2SavedKg.toFixed(1);
      document.getElementById('points').textContent = state.points;
      
      // Update desktop impact stats (hidden on mobile)
      const co2Desktop = document.getElementById('co2Desktop');
      if (co2Desktop) co2Desktop.textContent = state.co2SavedKg.toFixed(1);

      // clear
      list.innerHTML='';
      if (listDesktop) listDesktop.innerHTML='';

      const filtered = getFilteredRides();
      if (count) count.textContent = filtered.length + ' ride(s)';
      
      if (filtered.length === 0) {
         const noRides = `<div class="muted" style="text-align:center; padding: 24px;">No available rides matching your criteria.</div>`;
         list.innerHTML = noRides;
         if (listDesktop) listDesktop.innerHTML = noRides;
      }

      filtered.forEach(r=>{
        // list row
        const row = document.createElement('button');
        row.className = 'row-item';
        // Add course badges if applicable
        const courseBadges = r.courses.length > 0 ? r.courses.map(c => `<span class="badge" style="background:#e0f2f1">${c.toUpperCase()}</span>`).join(' ') : '';
        
        row.innerHTML = `<div class="avatar">${r.driverInitials}</div>
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px"><strong>${r.driver}</strong> <span class="badge">‚≠ê ${r.rating.toFixed(1)}</span> ${courseBadges}</div>
            <div class="muted" style="font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.from} ‚Üí ${r.to}</div>
            <div class="muted" style="display:flex;gap:12px;font-size:14px;margin-top:4px">
              <span>‚è∞ ${r.departTime}</span>
              <span>üë• ${r.seats} seats</span>
              <span>üí≤ ~$${r.costShare}</span>
            </div>
          </div>
          <span>‚Ä∫</span>`;
        row.onclick = ()=>{ state.selectedRideId = r.id; state.selectedChatId = null; show('details'); };
        
        // Append to both mobile and desktop lists (only one will be visible based on CSS)
        list.appendChild(row.cloneNode(true));
        if (listDesktop) listDesktop.appendChild(row);
      });
    }
    
    // -------- postRide function --------
    document.getElementById('postRide').addEventListener('click', ()=>{
      const fromSelect = document.getElementById('offerFrom').value;
      const toSelect = document.getElementById('offerTo').value;
      
      // Check if driver is verified and has a car registered
      if(state.asDriver && (!state.carMake || !state.carModel)){
          alert('Please complete your car registration details first. Go to Profile > Register Car.');
          show('registerCar');
          return;
      }
      if(!state.isVerified){
          alert('Please verify your profile first to post a ride.');
          show('onboard');
          return;
      }
      
      // Determine final "From" location
      const finalFrom = fromSelect === 'Custom' 
          ? document.getElementById('offerFromCustom').value || 'Custom Pickup'
          : fromSelect;

      // Determine final "To" location
      const finalTo = toSelect === 'Custom'
          ? document.getElementById('offerToCustom').value || 'Custom Dropoff'
          : toSelect;
          
      if (!finalFrom || !finalTo) {
          alert('Please select or enter both a valid From and To location.');
          return;
      }

      // Read other fields
      const departTime = document.getElementById('offerTime').value || '09:00';
      const seats = Math.max(1, parseInt(document.getElementById('offerSeats').value||'2',10));
      const costShare = parseFloat(document.getElementById('offerCost').value||'2');
      const notes = document.getElementById('offerNotes').value;
      
      // MOCK: If the user selected Recurring Ride, assume it's for their main courses
      const offerRecurringEl = document.getElementById('offerRecurring');
      const isRecurring = offerRecurringEl ? offerRecurringEl.checked : false;
      const rideCourses = isRecurring ? [...state.userCourses] : [];


      const newRide = {
        id:'r'+(RIDES.length+1),driver:state.userName.split(' ')[0]||'You',driverInitials:state.userName.split(' ').map(n=>n[0]).join('').toUpperCase().substring(0,2),
        rating:5.0,seats,departTime,from:finalFrom,to:finalTo,costShare,notes,gender:state.genderPref,
        car: state.carMake + ' ' + state.carModel,
        etiquette: [...state.rideEtiquette], // Use a copy of the current etiquette
        courses: rideCourses // Added course data
      };
      RIDES.unshift(newRide);
      state.points += 5;
      state.co2SavedKg = +(state.co2SavedKg + 1.2).toFixed(1);
      state.ridesCompleted += 1; // Increment ride count
      alert('Ride posted! (demo)');
      show('home');
    });

    function renderFind(){
      // Sync Filters with State
      document.getElementById('filterTime').value = state.timeFilter;
      
      // Highlight filter buttons
      document.querySelectorAll('[data-course-filter]').forEach(btn => {
          if (btn.getAttribute('data-course-filter') === state.courseFilter) {
              btn.classList.add('primary');
          } else {
              btn.classList.remove('primary');
          }
      });
      document.querySelectorAll('[data-gender-filter]').forEach(btn => {
          if (btn.getAttribute('data-gender-filter') === state.genderPref) {
              btn.classList.add('primary');
          } else {
              btn.classList.remove('primary');
          }
      });


      const res = document.getElementById('results');
      const resultsCount = document.getElementById('resultsCount');
      res.innerHTML='';

      const filtered = getFilteredRides();
      resultsCount.textContent = filtered.length + ' match(es)';

      filtered.forEach(r=>{
        const row = document.createElement('button');
        row.className = 'row-item';
        const courseBadges = r.courses.length > 0 ? r.courses.map(c => `<span class="badge" style="background:#e0f2f1">${c.toUpperCase()}</span>`).join(' ') : '';
        
        row.innerHTML = `<div class="avatar">${r.driverInitials}</div>
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px"><strong>${r.driver}</strong> <span class="badge">‚≠ê ${r.rating.toFixed(1)}</span> ${courseBadges}</div>
            <div class="muted" style="font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.from} ‚Üí ${r.to}</div>
            <div class="muted" style="display:flex;gap:12px;font-size:14px;margin-top:4px">
              <span>‚è∞ ${r.departTime}</span>
              <span>üë• ${r.seats} seats</span>
              <span>üí≤ ~$${r.costShare}</span>
            </div>
          </div>
          <span>‚Ä∫</span>`;
        row.onclick = ()=>{ state.selectedRideId = r.id; state.selectedChatId = null; show('details'); };
        res.appendChild(row);
      });
    }

    document.querySelector('[data-apply-filters]').addEventListener('click', ()=>{
      state.timeFilter = document.getElementById('filterTime').value;
      show('home');
    });

    document.querySelectorAll('[data-gender-filter]').forEach(btn=>btn.addEventListener('click', e=>{
      const group = e.currentTarget.parentElement;
      group.querySelectorAll('.btn').forEach(b=>b.classList.remove('primary'));
      e.currentTarget.classList.add('primary');
      
      state.genderPref = e.currentTarget.getAttribute('data-gender-filter');
      renderFind();
    }));

    document.querySelectorAll('[data-course-filter]').forEach(btn=>btn.addEventListener('click', e=>{
      const group = e.currentTarget.parentElement;
      group.querySelectorAll('.btn').forEach(b=>b.classList.remove('primary'));
      e.currentTarget.classList.add('primary');
      
      state.courseFilter = e.currentTarget.getAttribute('data-course-filter');
      renderFind();
    }));
    
    // NEW: renderChatDetails - Renders the mock chat screen
    function renderChatDetails() {
        const card = document.getElementById('detailsCard');
        const header = document.getElementById('detailsHeader');
        const chat = CHATS[state.selectedChatId];
        
        if (!chat) { card.innerHTML = '<div class="card-c">No chat selected.</div>'; return; }
        
        // 1. Render Header (FIXED: Using onclick="show('messages')" for back button)
        header.innerHTML = `‚Üê <button class="btn ghost" onclick="show('messages')">Back</button> ${chat.partner}`;

        // 2. Render Chat Messages
        const messageHistory = chat.messages.map(m => {
            const senderName = m.sender ? m.sender + ': ' : '';
            return `<div class="message ${m.type}">${senderName}${m.text}</div>`;
        }).join('');

        card.innerHTML = `
            <div class="card-h" style="justify-content:space-between">
                <div style="display:flex;align-items:center;gap:10px">
                    <div class="avatar" style="background:${chat.color}">${chat.initials}</div>
                    <strong>${chat.partner}</strong>
                </div>
                <button class="btn ghost">üìû Call (Mock)</button>
            </div>
            <div class="card-c">
                <div class="chat-box">${messageHistory}</div>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <input class="input" placeholder="Type your message..." />
                    <button class="btn primary">Send</button>
                </div>
            </div>`;
    }

    // renderDetails (Existing ride details)
    function renderDetails(){
      const card = document.getElementById('detailsCard');
      const header = document.getElementById('detailsHeader');
      const ride = RIDES.find(r=>r.id===state.selectedRideId);
      
      if(!ride){ card.innerHTML = '<div class="card-c">No ride selected.</div>'; return; }
      
      // 1. Render Header (FIXED: Using onclick="show('home')" for back button)
      header.innerHTML = `‚Üê <button class="btn ghost" onclick="show('home')">Back</button> Ride details`;

      // Use car info if available on the ride object
      const carDetail = ride.car ? `<div class="pill" style="display:flex;align-items:center;justify-content:space-between"><span>üöó Vehicle</span><strong>${ride.car}</strong></div>` : '';
      
      // Etiquette display
      const etiquetteHtml = ride.etiquette && ride.etiquette.length > 0
          ? ride.etiquette.map(e => `<span class="k">${e}</span>`).join('')
          : '<span class="muted">No specific etiquette requested.</span>';
          
      // Course display
      const courseHtml = ride.courses && ride.courses.length > 0
          ? ride.courses.map(c => `<span class="k" style="background:#e0f2f1">üìö ${c.toUpperCase()} Match</span>`).join('')
          : '<span class="muted">Not associated with a specific course.</span>';


      card.innerHTML = `
        <div class="card-h">
          <div class="avatar">${ride.driverInitials}</div>
          <div style="flex:1">
            <div class="title" style="display:flex;align-items:center;gap:8px">${ride.driver} <span class="badge">‚≠ê ${ride.rating.toFixed(1)}</span></div>
            <div class="muted" style="font-size:14px">Verified SFU Student</div>
          </div>
        </div>
        <div class="card-c">
          <div class="grid-2">
            <div class="pill">
              <div class="label">Route</div>
              <div class="title" style="font-weight:600">${ride.from} ‚Üí ${ride.to}</div>
            </div>
            <div class="pill" style="display:flex;align-items:center;justify-content:space-between"><span>‚è∞ Departure</span><strong>${ride.departTime}</strong></div>
            <div class="pill" style="display:flex;align-items:center;justify-content:space-between"><span>üë• Seats</span><strong>${ride.seats}</strong></div>
            <div class="pill" style="display:flex;align-items:center;justify-content:space-between"><span>üí≤ Cost share</span><strong>~$${ride.costShare}</strong></div>
          </div>
          <div class="grid-2" style="margin-top:8px">
            ${carDetail}
          </div>
          
          <div class="pill" style="margin-top:8px">
              <div class="label">Linked Courses</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">${courseHtml}</div>
          </div>
          
          <div class="pill" style="margin-top:8px">
              <div class="label">Ride Etiquette</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">${etiquetteHtml}</div>
          </div>

          ${ride.notes?`<div class="pill" style="margin-top:8px"><strong>Notes:</strong> <span class="muted">${ride.notes}</span></div>`:''}
          
          <div class="grid-actions" style="margin-top:12px">
            <button class="btn brand" id="reqJoin" ${state.isVerified ? '' : 'disabled'}>Request to join</button>
            <button class="btn" onclick="showChat('chat-alex')">üí¨ Message</button>
          </div>
          <div class="grid-3" style="margin-top:12px">
            <div class="k">üîê Safety: live-share ETA, SOS, check-ins (demo)</div>
            <div class="k">üÜò Emergency Contact: ${state.emergencyContact ? state.emergencyContact.name : 'Not set'}</div>
            <div class="k">üåç Impact: ~0.8 kg CO‚ÇÇ saved vs solo</div>
          </div>
        </div>`;
      if(document.getElementById('reqJoin')) document.getElementById('reqJoin').onclick = ()=>{
        state.points += 10;
        state.co2SavedKg = +(state.co2SavedKg + 2.4).toFixed(1);
        alert('Request sent! (demo)');
        show('home');
      };
    }

    function renderRewards(){
      document.getElementById('points').textContent = state.points;
      document.getElementById('co2Big').textContent = state.co2SavedKg.toFixed(1);
      const lb = document.getElementById('leaderboard');
      lb.innerHTML = '';
      
      // Render Leaderboard
      // 1. Annika Tan (was Maya P)
      // 2. Kaidin SD (was Alex C)
      // 3. Rex F (was Fatima Z)
      // 4. You
      ['Annika Tan','Kaidin SD','Rex F','You'].forEach((n,i)=>{
        const row = document.createElement('div');
        row.className='row-item';
        // Removed trophy emoji
        row.innerHTML = `<div style="display:flex;align-items:center;gap:8px">#${i+1}. ${n}</div><div style="margin-left:auto">${50 - i*10} kg CO‚ÇÇ</div>`;
        lb.appendChild(row);
      });
      
      // --- Referral Code Logic (NEW) ---
      let referralName = state.userName.split(' ')[0];
      // Check if the user is using the default "Guest Rider" name
      if (referralName === 'Guest') {
          referralName = 'JANE'; 
      }
      const referralCode = `SFU-RIDE-${referralName.toUpperCase()}`;
      
      const codeElement = document.getElementById('referralCodeDisplay');
      if (codeElement) {
          codeElement.textContent = referralCode;
      }
      // --- End Referral Code Logic ---

      
      // Render Trophies
      const trophyGrid = document.getElementById('trophyGrid');
      trophyGrid.innerHTML = '';
      
      TROPHIES.forEach(trophy => {
          const unlocked = state.co2SavedKg >= trophy.threshold;
          const trophyItem = document.createElement('div');
          trophyItem.className = `trophy-item ${unlocked ? 'unlocked' : ''}`;
          // Replaced trophy emoji with simple text/symbol from updated TROPHIES array
          const iconDisplay = unlocked ? trophy.icon : 'üîí';
          trophyItem.innerHTML = `
            <span class="trophy-icon">${iconDisplay}</span>
            <div class="trophy-title">${trophy.title}</div>
            <div class="trophy-caption">${trophy.caption}</div>
          `;
          trophyGrid.appendChild(trophyItem);
      });
      
      // Render Missions (NEW)
      const missionsBar = document.getElementById('missionsBar');
      missionsBar.innerHTML = '';
      
      MISSIONS.forEach(mission => {
          const missionDiv = document.createElement('div');
          missionDiv.className = `mission-item ${mission.completed ? 'complete' : ''}`;
          // Replaced mission emoji with simple text/symbol from updated MISSIONS array
          const iconDisplay = mission.completed ? '‚úì' : mission.icon; 
          missionDiv.innerHTML = `
            <span class="mission-icon">${iconDisplay}</span>
            <div class="mission-text">${mission.text}</div>
            <div class="mission-reward">
                +${mission.reward} Pts
                <button class="btn primary small" style="margin-left: 8px;" ${mission.completed ? 'disabled' : ''}>${mission.completed ? 'Completed' : mission.buttonText}</button>
            </div>
          `;
          missionsBar.appendChild(missionDiv);
      });
    }

    // initial mount
    show('welcome');
  </script>
</body>
</html>